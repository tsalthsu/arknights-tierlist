<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Arknights Skin Tier List</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    <style>
        /* --- CSS ìŠ¤íƒ€ì¼ --- */
        :root {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --panel-bg: #222;
            --item-bg: #2b2b2b;
            --border-color: #444;
            --card-bg: #333;
            --card-border: #555;
            --modal-bg: #2a2a2a;
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --shadow: rgba(0,0,0,0.5);
            --accent-color: #1976d2;
        }
        [data-theme="light"] {
            --bg-color: #f0f2f5;
            --text-color: #333333;
            --panel-bg: #ffffff;
            --item-bg: #e4e6eb;
            --border-color: #ccc;
            --card-bg: #fff;
            --card-border: #bbb;
            --modal-bg: #fff;
            --modal-overlay: rgba(0, 0, 0, 0.3);
            --shadow: rgba(0,0,0,0.1);
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background 0.3s, color 0.3s;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        .nav-bar {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .nav-title { font-size: 1.5rem; font-weight: bold; text-transform: uppercase; }
        .nav-links { display: flex; gap: 10px; align-items: center; }
        .nav-btn {
            text-decoration: none;
            color: var(--text-color);
            background-color: var(--panel-bg);
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            transition: 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .nav-btn:hover { background-color: var(--border-color); }
        .nav-btn.active { background-color: var(--accent-color); border-color: var(--accent-color); color: white; }
        
        .lang-select {
            background-color: var(--panel-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 5px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        /* ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        .controls { margin-bottom: 20px; display: flex; gap: 10px; }
        .btn {
            background-color: var(--panel-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px 25px;
            cursor: pointer;
            font-size: 1rem;
            border-radius: 4px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .btn-submit { background-color: #1976d2; color: white; border-color: #0d47a1; }
        .btn-reset { background-color: #c62828; color: white; border-color: #b71c1c; }
        
        .tier-container { width: 100%; max-width: 1200px; display: flex; flex-direction: column; gap: 10px; margin-bottom: 50px; }
        .tier-row { display: flex; min-height: 160px; background-color: var(--panel-bg); border: 1px solid var(--border-color); }
        .tier-label {
            width: 100px; display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; font-weight: 900; flex-shrink: 0;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5); color: #333; user-select: none;
        }
        .tier-content {
            flex-grow: 1; padding: 10px; display: flex; flex-wrap: wrap; gap: 10px;
            background-color: var(--item-bg); align-content: flex-start; transition: background 0.3s;
        }
        .pool-section {
            width: 100%; max-width: 1200px; border: 2px dashed var(--border-color);
            padding: 20px; background-color: var(--panel-bg); transition: background 0.3s;
        }
        .pool-title { margin-top: 0; margin-bottom: 15px; color: #888; }
        .item-pool { display: flex; flex-wrap: wrap; gap: 15px; min-height: 200px; }
        .skin-card {
            width: 100px; height: 180px; background-color: var(--card-bg);
            border: 1px solid var(--card-border); cursor: grab; position: relative;
            overflow: hidden; transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px var(--shadow);
        }
        .skin-card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .skin-card:hover {
            transform: translateY(-7px) scale(1.02); box-shadow: 0 10px 20px var(--shadow);
            border-color: var(--text-color); z-index: 10;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--modal-overlay); display: none;
            justify-content: center; align-items: center; z-index: 1000;
            backdrop-filter: blur(3px);
        }
        .modal-box {
            background-color: var(--modal-bg); color: var(--text-color);
            border: 1px solid var(--border-color); padding: 25px; border-radius: 8px;
            width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal-msg { margin-bottom: 20px; font-size: 1.1rem; line-height: 1.5; }
        .modal-actions { display: flex; justify-content: center; gap: 10px; }
        .modal-btn { padding: 10px 20px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
        .modal-btn.confirm { background-color: #1976d2; color: white; }
        .modal-btn.cancel { background-color: var(--border-color); color: var(--text-color); }
        .theme-toggle {
            position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px;
            border-radius: 50%; background-color: var(--panel-bg);
            border: 2px solid var(--border-color); color: var(--text-color);
            font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 10px var(--shadow);
            z-index: 100; display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-left">
            <div class="nav-title" id="txt-title">2025 Arknights Skin Tier List</div>
        </div>
        <div class="nav-links">
            <select id="langSelect" class="lang-select" onchange="window.changeLanguage(this.value)">
                <option value="ko">í•œêµ­ì–´</option>
                <option value="en">English</option>
                <option value="jp">æ—¥æœ¬èª</option>
                <option value="cn">ä¸­æ–‡</option>
            </select>
            <a href="index.html" class="nav-btn active" id="nav-btn-make">Make List</a>
            <a href="gallery.html" class="nav-btn" id="nav-btn-gallery">Gallery</a>
            <a href="stats.html" class="nav-btn" id="nav-btn-stats">Stats</a>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-submit" onclick="window.submitTierList()" id="btn-submit">Submit</button>
        <button class="btn btn-reset" onclick="window.tryReset()" id="btn-reset">Reset</button>
    </div>

    <div class="tier-container" id="tier-container"></div>

    <div class="pool-section">
        <h3 class="pool-title" id="txt-pool">Unranked Skins</h3>
        <div class="item-pool" id="pool"></div>
    </div>

    <button class="theme-toggle" onclick="window.toggleTheme()">
        <span id="theme-icon">â˜€ï¸</span>
    </button>

    <div class="modal-overlay" id="confirmModal">
        <div class="modal-box">
            <div class="modal-msg" id="modal-msg">Message</div>
            <div class="modal-actions">
                <button class="modal-btn confirm" id="modal-yes">Yes</button>
                <button class="modal-btn cancel" onclick="window.closeModal()" id="modal-no">No</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        // [ìˆ˜ì •] writeBatch, doc, increment, setDoc ì¶”ê°€ (ë°ì´í„° ìµœì í™”ë¥¼ ìœ„í•´ í•„ìš”)
        import { getFirestore, collection, addDoc, writeBatch, doc, increment, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC7z3JsiRzPSXnOdxtazbtq2J41oORv9og",
            authDomain: "skin-cad0f.firebaseapp.com",
            projectId: "skin-cad0f",
            storageBucket: "skin-cad0f.firebasestorage.app",
            messagingSenderId: "343015548730",
            appId: "1:343015548730:web:d65503a46d1fbabbf59203",
            measurementId: "G-P1NC2B9TE5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // [ì¶”ê°€] ì ìˆ˜ ê³„ì‚°ì„ ìœ„í•œ ë§¤í•‘
        const scoreMap = { 'S': 5, 'A': 4, 'B': 3, 'C': 2, 'D': 1, 'F': 0 };

        const pathPrefix = "img/"; 
        const totalImages = 110; 
        const fixedTiers = [
            { label: 'S', color: '#ff7f7f' },
            { label: 'A', color: '#ffbf7f' },
            { label: 'B', color: '#ffff7f' },
            { label: 'C', color: '#7fff7f' },
            { label: 'D', color: '#7fbfff' },
            { label: 'F', color: '#bfbfbf' }
        ];

        const i18n = {
            ko: {
                title: "2025 ëª…ì¼ë°©ì£¼ ìŠ¤í‚¨ ì—°ë§ì •ì‚°",
                submit: "ì œì¶œí•˜ê¸°",
                reset: "ì´ˆê¸°í™”",
                pool: "ëŒ€ê¸°ì—´ (ë“œë˜ê·¸í•˜ì—¬ ì´ë™)",
                confirmReset: "ëª¨ë“  ë°°ì¹˜ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.<br>ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                submitFail: "ìµœì†Œ 5ê°œ ì´ìƒì˜ ì•„ì´í…œì„<br>í‹°ì–´í‘œì— ë°°ì¹˜í•´ì£¼ì„¸ìš”!",
                submitSuccess: "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!<br>ê°¤ëŸ¬ë¦¬ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.",
                saveError: "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
                yes: "í™•ì¸",
                no: "ì·¨ì†Œ",
                navMake: "ì œì‘í•˜ê¸°",
                navGallery: "ê°¤ëŸ¬ë¦¬",
                navStats: "í†µê³„"
            },
            en: {
                title: "2025 Arknights Skin Year-End",
                submit: "Submit",
                reset: "Reset",
                pool: "Unranked Skins",
                confirmReset: "All placements will be reset.<br>Proceed?",
                submitFail: "Please place at least 5 items<br>to submit.",
                submitSuccess: "Saved successfully!<br>Redirecting to gallery...",
                saveError: "Error saving data.<br>Please try again later.",
                yes: "Yes",
                no: "No",
                navMake: "Make List",
                navGallery: "Gallery",
                navStats: "Stats"
            },
            jp: {
                title: "2025 ã‚¢ãƒ¼ã‚¯ãƒŠã‚¤ãƒ„ ã‚³ãƒ¼ãƒ‡ å¹´æœ«æ±ºç®—",
                submit: "æå‡ºã™ã‚‹",
                reset: "ãƒªã‚»ãƒƒãƒˆ",
                pool: "æœªé…ç½®ãƒªã‚¹ãƒˆ",
                confirmReset: "å…¨ã¦ã®é…ç½®ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚<br>ç¶šã‘ã¾ã™ã‹ï¼Ÿ",
                submitFail: "5ã¤ä»¥ä¸Šã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’<br>é…ç½®ã—ã¦ãã ã•ã„ã€‚",
                submitSuccess: "ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼<br>ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¾ã™ã€‚",
                saveError: "ä¿å­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚",
                yes: "ç¢ºèª",
                no: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
                navMake: "ä½œæˆ",
                navGallery: "ã‚®ãƒ£ãƒ©ãƒªãƒ¼",
                navStats: "çµ±è¨ˆ"
            },
            cn: {
                title: "2025 æ˜æ—¥æ–¹èˆŸ æ—¶è£… å¹´ç»ˆç›˜ç‚¹",
                submit: "æäº¤",
                reset: "é‡ç½®",
                pool: "æœªæ’åçš®è‚¤",
                confirmReset: "æ‰€æœ‰å¸ƒå±€å°†è¢«é‡ç½®ã€‚<br>æ˜¯å¦ç»§ç»­ï¼Ÿ",
                submitFail: "è¯·è‡³å°‘æ”¾ç½®5ä¸ªç‰©å“<br>ä»¥è¿›è¡Œæäº¤ã€‚",
                submitSuccess: "ä¿å­˜æˆåŠŸï¼<br>å³å°†è·³è½¬åˆ°ç”»å»Šé¡µé¢ã€‚",
                saveError: "ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚",
                yes: "ç¡®è®¤",
                no: "å–æ¶ˆ",
                navMake: "åˆ¶ä½œ",
                navGallery: "ç”»å»Š",
                navStats: "ç»Ÿè®¡"
            }
        };

        let currentLang = 'ko';

        window.onload = function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const icon = document.getElementById('theme-icon');
            icon.textContent = savedTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';

            // ì–¸ì–´ ì„¤ì • ë³µì›
            const savedLang = localStorage.getItem('lang');
            if (savedLang && i18n[savedLang]) {
                currentLang = savedLang;
            } else {
                window.detectLanguage();
            }
            document.getElementById('langSelect').value = currentLang;
            window.updateText();

            loadImages();
            createFixedTiers();
        };

        // [ìˆ˜ì •ë¨] ë°ì´í„° ì €ì¥ ë° í†µê³„ ëˆ„ì  í•¨ìˆ˜
        window.submitTierList = async function() {
            // 1. ë°ì´í„° ì¤€ë¹„
            const resultData = {
                timestamp: new Date().toISOString(),
                tiers: {}
            };
            
            let totalPlacedCount = 0;

            // DOMì—ì„œ ë°°ì¹˜ëœ ì¹´ë“œ ì •ë³´ ìˆ˜ì§‘
            document.querySelectorAll('.tier-row').forEach(row => {
                const tierName = row.getAttribute('data-tier');
                const items = [];
                const cards = row.querySelectorAll('.skin-card');
                cards.forEach(card => {
                    const skinId = card.getAttribute('data-id');
                    items.push(skinId);
                    totalPlacedCount++;
                });
                resultData.tiers[tierName] = items;
            });

            // ìµœì†Œ ê°œìˆ˜ ì²´í¬
            if (totalPlacedCount < 5) {
                window.showModal(i18n[currentLang].submitFail, null, false);
                return;
            }

            const submitBtn = document.getElementById('btn-submit');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = "Saving...";
            submitBtn.disabled = true;

            try {
                // [í•µì‹¬ ë¡œì§ ë³€ê²½] ì¼ê´„ ì“°ê¸°(Batch) ì‹œì‘
                const batch = writeBatch(db);

                // A. ê°œë³„ ê²°ê³¼ ì €ì¥ (ê¸°ì¡´ tier_results ì»¬ë ‰ì…˜)
                // addDoc ëŒ€ì‹  doc()ìœ¼ë¡œ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ë¨¼ì € ë§Œë“¤ê³  batch.set ì‚¬ìš©
                const newHistoryRef = doc(collection(db, "tier_results"));
                batch.set(newHistoryRef, resultData);

                // B. í†µê³„ ìš”ì•½ ë¬¸ì„œ ì—…ë°ì´íŠ¸ (statistics/summary ë¬¸ì„œ)
                const statsRef = doc(db, "statistics", "summary");
                
                // ì—…ë°ì´íŠ¸í•  í•„ë“œ ì¤€ë¹„
                const updates = {
                    totalSubmissions: increment(1),
                    lastUpdated: new Date().toISOString()
                };

                // ê° ìŠ¤í‚¨ë³„ ì ìˆ˜ ë° ì¹´ìš´íŠ¸ ëˆ„ì 
                Object.entries(resultData.tiers).forEach(([tier, items]) => {
                    const score = scoreMap[tier];
                    if (score === undefined) return;

                    items.forEach(skinId => {
                        // Firestore í‚¤ì— '.'ì´ í¬í•¨ë˜ë©´ ì•ˆ ë˜ë¯€ë¡œ '_'ë¡œ ì¹˜í™˜
                        const safeKey = skinId.replace(/\./g, '_');
                        
                        // ì ìˆ˜ í•©ì‚°
                        updates[`skins.${safeKey}.totalScore`] = increment(score);
                        // íˆ¬í‘œ íšŸìˆ˜ í•©ì‚°
                        updates[`skins.${safeKey}.count`] = increment(1);
                        // í‹°ì–´ë³„ íšŸìˆ˜ í•©ì‚°
                        updates[`skins.${safeKey}.tierCounts.${tier}`] = increment(1);
                        // ì›ë³¸ ID ì €ì¥ (ë‚˜ì¤‘ì— ë³µì›ì„ ìœ„í•´)
                        updates[`skins.${safeKey}.id`] = skinId;
                    });
                });

                // setDoc + merge: trueë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ìƒì„±, ìˆìœ¼ë©´ ë³‘í•©
                batch.set(statsRef, updates, { merge: true });

                // ë°°ì¹˜ ì»¤ë°‹ (ì „ì†¡)
                await batch.commit();

                // ì„±ê³µ ëª¨ë‹¬ í‘œì‹œ í›„ ì´ë™
                window.showModal(i18n[currentLang].submitSuccess, () => {
                    window.location.href = 'gallery.html';
                }, false);

            } catch (e) {
                console.error("Error adding document: ", e);
                window.showModal(i18n[currentLang].saveError + "<br>(" + e.message + ")", null, false);
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        window.detectLanguage = function() {
            const userLang = navigator.language.slice(0, 2);
            if (['ko', 'en', 'ja', 'zh'].includes(userLang)) {
                currentLang = (userLang === 'ja') ? 'jp' : (userLang === 'zh') ? 'cn' : userLang;
            } else {
                currentLang = 'en';
            }
        }

        window.changeLanguage = function(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            window.updateText();
        }

        window.updateText = function() {
            const t = i18n[currentLang];
            document.getElementById('txt-title').textContent = t.title;
            document.getElementById('btn-submit').textContent = t.submit;
            document.getElementById('btn-reset').textContent = t.reset;
            document.getElementById('txt-pool').textContent = t.pool;
            document.getElementById('modal-yes').textContent = t.yes;
            document.getElementById('modal-no').textContent = t.no;
            
            document.getElementById('nav-btn-make').textContent = t.navMake;
            document.getElementById('nav-btn-gallery').textContent = t.navGallery;
            document.getElementById('nav-btn-stats').textContent = t.navStats;
        }

        function loadImages() {
            const pool = document.getElementById('pool');
            pool.innerHTML = '';
            for (let i = 1; i <= totalImages; i++) {
                const number = String(i).padStart(3, '0');
                const card = document.createElement('div');
                card.className = 'skin-card';
                card.setAttribute('data-id', `skin_${number}.png`);
                card.innerHTML = `<img src="${pathPrefix}skin_${number}.png" onerror="this.parentElement.style.display='none'">`;
                pool.appendChild(card);
            }
            new Sortable(pool, { group: 'shared', animation: 150 });
        }

        function createFixedTiers() {
            const container = document.getElementById('tier-container');
            container.innerHTML = '';
            fixedTiers.forEach(tier => {
                const row = document.createElement('div');
                row.className = 'tier-row';
                row.setAttribute('data-tier', tier.label);
                const label = document.createElement('div');
                label.className = 'tier-label';
                label.textContent = tier.label;
                label.style.backgroundColor = tier.color;
                const content = document.createElement('div');
                content.className = 'tier-content';
                content.id = `tier-${tier.label}`;
                row.appendChild(label);
                row.appendChild(content);
                container.appendChild(row);
                new Sortable(content, { group: 'shared', animation: 150 });
            });
        }

        window.tryReset = function() {
            const itemsInTiers = document.querySelectorAll('.tier-content .skin-card');
            if (itemsInTiers.length > 0) {
                window.showModal(i18n[currentLang].confirmReset, () => {
                    const pool = document.getElementById('pool');
                    const allItems = document.querySelectorAll('.skin-card');
                    allItems.forEach(item => pool.appendChild(item));
                    sortPoolItems(); 
                }, true);
            }
        }

        function sortPoolItems() {
            const pool = document.getElementById('pool');
            const items = Array.from(pool.children);
            items.sort((a, b) => a.getAttribute('data-id').localeCompare(b.getAttribute('data-id')));
            items.forEach(item => pool.appendChild(item));
        }

        window.showModal = function(msgHTML, callbackYes, hasCancel = true) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('modal-msg').innerHTML = msgHTML;
            const btnYes = document.getElementById('modal-yes');
            const btnNo = document.getElementById('modal-no');
            btnNo.style.display = hasCancel ? 'inline-block' : 'none';
            modal.style.display = 'flex';
            
            const newYesBtn = btnYes.cloneNode(true);
            btnYes.parentNode.replaceChild(newYesBtn, btnYes);
            newYesBtn.onclick = function() {
                if (callbackYes) callbackYes();
                window.closeModal();
            };
        }

        window.closeModal = function() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        window.toggleTheme = function() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'dark';
            const icon = document.getElementById('theme-icon');
            let nextTheme;
            
            if (currentTheme === 'light') {
                nextTheme = 'dark';
                icon.textContent = 'â˜€ï¸';
            } else {
                nextTheme = 'light';
                icon.textContent = 'ğŸŒ™';
            }
            html.setAttribute('data-theme', nextTheme);
            localStorage.setItem('theme', nextTheme);
        }
    </script>
</body>
</html>
